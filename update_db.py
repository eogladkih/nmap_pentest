from db_CVE import CVE, Date, db_session
from datetime import datetime
import requests


def get_names_os():
	names_os = []
	for cve in CVE.query.all():
		if cve.name not in names_os:
			names_os.append(cve.name)

	return names_os


def get_all_cve_lot(names_os):
	cve_lot = {}
	for name_os in names_os:
		cve_id_list = []
		for cve in CVE.query.all():
			if cve.name == name_os:
				cve_id_list.append(cve.id)
		cve_lot[name_os] = set(cve_id_list)

	return cve_lot


def get_cve_lot_os(names_os):
	renewed_cve = {}
	#name = 'microsoft/windows_10'

	for name_os in names_os:
		#if name_os == name:
		print(name_os)
		url = 'http://cve.circl.lu/api/search/%s' %name_os
		id_CVE = []
		try:
			result = requests.get(url)
			result.raise_for_status()

			if type(result.json()) == list:
				for el in result.json():
					id_CVE.append(el['id'])
			elif type(result.json()) == dict:
				for el in result.json()['data']:
					id_CVE.append(el['id'])
			else:
				print('Другой формат. Не умею пока такое обрабатывать.')

		except requests.exceptions.RequestException as e:
			print(e)
			return False

		renewed_cve[name_os] = set(id_CVE)

	return renewed_cve


def get_references(cve):
	references_list = []
	url = 'http://cve.circl.lu/api/cve/%s' %cve
	try:
			result = requests.get(url)
			result.raise_for_status()

			for references in result.json()['references']:
				references_list.append(references)


	except requests.exceptions.RequestException as e:
		print(e)
		return False

	print (references_list)
	return references_list


def update_cve(cve_lot, renewed_cve):
	for name_os in cve_lot:
		for name_os_renewed in renewed_cve:
			if name_os == name_os_renewed:
				new_cve = renewed_cve[name_os_renewed] - cve_lot[name_os]
				if len(new_cve) != 0:
					for cve in new_cve:
						references = get_references(cve)
						references = str(references).replace('[', '').replace(']', '').replace("'", '')
						db_session.add(CVE(cve, name_os, references))

				update_date(name_os)

	db_session.commit()


def update_date(name_os):
	dt = datetime.now().strftime('%d.%m.%y %H:%M')
	for date in Date.query.all():
		if date.name == name_os:
			date.date = dt

	db_session.commit()


if __name__ == "__main__":
	names_os = get_names_os()
	cve_lot = get_all_cve_lot(names_os)
	renewed_cve = get_cve_lot_os(names_os)
	update_cve(cve_lot, renewed_cve)







