import requests
from db_CVE import CVE, SYSTEM_NAME, db_session, Date
from datetime import datetime


def fill_db(SYSTEM_NAME):
    id_CVE = ''
	references = ''
	url = 'http://cve.circl.lu/api/search/%s' %SYSTEM_NAME
	try:
		result = requests.get(url)
		result.raise_for_status()

		if type(result.json()) == list:
			for el in result.json():
				id_CVE = el['id']
				references = str(el['references']).replace('[', '').replace(']', '').replace("'", '')
				db_session.add(CVE(id_CVE, SYSTEM_NAME, references))
		elif type(result.json()) == dict:
			for el in result.json()['data']:
				id_CVE = el['id']
				references = str(el['references']).replace('[', '').replace(']', '').replace("'", '')
				db_session.add(CVE(id_CVE, SYSTEM_NAME, references))
		else:
			print('Другой формат. Не умею пока такое обрабатывать.')

		db_session.commit()

	except requests.exceptions.RequestException as e:
		print(e)
		return False


def fill_date(SYSTEM_NAME):
	dt = datetime.now().strftime('%d.%m.%y %H:%M')
	db_session.add(Date(SYSTEM_NAME, dt))
	db_session.commit()


if __name__ == "__main__":
	print(SYSTEM_NAME)
	cve = fill_db(SYSTEM_NAME)
	date = fill_date(SYSTEM_NAME)
	